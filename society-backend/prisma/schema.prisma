// Prisma Schema for Society - Companion Booking Platform
// Based on Technical Documentation v2.0 - January 2026
// Optimized for PostgreSQL performance
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  HIRER
  COMPANION
  ADMIN
}

enum UserStatus {
  PENDING
  ACTIVE
  SUSPENDED
  DELETED
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum VerificationStatus {
  PENDING
  UNDER_REVIEW
  VERIFIED
  FAILED
  EXPIRED
}

enum ServiceType {
  FAMILY_INTRODUCTION
  WEDDING_ATTENDANCE
  TET_COMPANIONSHIP
  BUSINESS_EVENT
  CASUAL_OUTING
  CLASS_REUNION
  OTHER
}

enum BookingStatus {
  PENDING // Request submitted by hirer
  CONFIRMED // Companion accepted
  ACTIVE // Booking in progress
  COMPLETED // Successfully completed
  CANCELLED // Either party cancelled
  DISPUTED // Under dispute resolution
  EXPIRED // Request timed out (24h no response)
}

enum PaymentStatus {
  PENDING
  PAID
  HELD // In escrow
  RELEASED // Released to companion
  REFUNDED
  PARTIAL_REFUND
  FAILED
}

enum PaymentProvider {
  BANK_TRANSFER
}

enum EarningsStatus {
  PENDING
  AVAILABLE
  WITHDRAWN
  CANCELLED
}

enum WithdrawalStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum NotificationType {
  BOOKING_REQUEST
  BOOKING_CONFIRMED
  BOOKING_DECLINED
  BOOKING_CANCELLED
  BOOKING_REMINDER
  BOOKING_COMPLETED
  NEW_MESSAGE
  NEW_REVIEW
  PAYMENT_RECEIVED
  WITHDRAWAL_COMPLETED
  ACCOUNT_VERIFIED
  SYSTEM
}

enum ReportType {
  HARASSMENT
  INAPPROPRIATE_BEHAVIOR
  NO_SHOW
  FRAUD
  FAKE_PROFILE
  SPAM
  SAFETY_CONCERN
  PAYMENT_ISSUE
  OTHER
}

enum ReportStatus {
  PENDING
  UNDER_REVIEW
  RESOLVED
  DISMISSED
}

enum StrikeType {
  LATE_CANCELLATION
  NO_SHOW
  POLICY_VIOLATION
  INAPPROPRIATE_BEHAVIOR
  FRAUD_ATTEMPT
  FAKE_REVIEW
  SPAM
}

enum MessageType {
  TEXT
  IMAGE
  LOCATION
  SYSTEM
}

enum ModerationStatus {
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
}

enum ModerationContentType {
  PROFILE
  PHOTO
  MESSAGE
  REPORT
}

enum ModerationActionType {
  APPROVE
  REJECT
  WARN
  SUSPEND
  BAN
}

enum AppealStatus {
  PENDING
  REVIEWING
  APPROVED
  REJECTED
}

enum CancellationType {
  REGULAR
  EMERGENCY
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id              String     @id @default(uuid()) @db.Uuid
  zaloId          String     @unique @map("zalo_id")
  phone           String?
  phoneHash       String?    @unique @map("phone_hash")
  isPhoneVerified Boolean    @default(false) @map("is_phone_verified")
  phoneVerifiedAt DateTime?  @map("phone_verified_at")
  email           String?
  fullName        String?    @map("full_name")
  avatarUrl       String?    @map("avatar_url")
  gender          Gender?
  dateOfBirth     DateTime?  @map("date_of_birth") @db.Date
  role            UserRole?
  status          UserStatus @default(PENDING)
  isVerified      Boolean    @default(false) @map("is_verified")
  trustScore      Int        @default(100) @map("trust_score")
  deletedAt       DateTime?  @map("deleted_at") // Soft delete support
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  // Relations
  settings UserSettings?
  devices  UserDevice[]
  sessions UserSession[]

  // Role-specific profiles
  companionProfile CompanionProfile?
  hirerProfile     HirerProfile?

  // Bookings
  hirerBookings     Booking[] @relation("HirerBookings")
  companionBookings Booking[] @relation("CompanionBookings")

  // Messaging (stored in Supabase for realtime)
  conversationsAsHirer     Conversation[] @relation("HirerConversations")
  conversationsAsCompanion Conversation[] @relation("CompanionConversations")
  messagesSent             Message[]

  // Reviews
  reviewsGiven    Review[] @relation("ReviewsGiven")
  reviewsReceived Review[] @relation("ReviewsReceived")

  // Trust & Safety
  blockedUsers    UserBlock[]  @relation("Blocker")
  blockedByUsers  UserBlock[]  @relation("Blocked")
  reportsMade     Report[]     @relation("Reporter")
  reportsReceived Report[]     @relation("Reported")
  strikes         UserStrike[]

  // Verifications
  verifications      Verification[]
  photoVerifications PhotoVerification[]

  // Notifications
  notifications Notification[]
  pushTokens    PushToken[]

  // Earnings & Payments
  payments        Payment[]
  paymentRequests PaymentRequest[]

  // Moderation
  moderationQueue   ModerationQueue[]
  moderationActions ModerationAction[] @relation("Moderator")
  suspensions       UserSuspension[]   @relation("SuspendedUser")
  suspendedBy       UserSuspension[]   @relation("SuspendedBy")
  liftedSuspensions UserSuspension[]   @relation("LiftedBy")
  appeals           Appeal[]
  appealReviews     Appeal[]           @relation("AppealReviewer")

  // Files
  files File[]

  // Security
  securityEvents SecurityEvent[]

  // Admin
  adminAuditLogs  AdminAuditLog[]
  supportTickets  SupportTicket[]        @relation("TicketUser")
  assignedTickets SupportTicket[]        @relation("TicketAssignee")
  ticketMessages  SupportTicketMessage[]

  // Referrals
  referral     Referral?
  referredBy   Referral? @relation("ReferredUsers", fields: [referredById], references: [id])
  referredById String?   @map("referred_by_id") @db.Uuid

  // Favorites
  favoriteCompanions FavoriteCompanion[] @relation("HirerFavorites")
  favoritedBy        FavoriteCompanion[] @relation("FavoritedBy")

  // Emergency & Safety
  emergencyContacts   EmergencyContact[]
  emergencyEvents     EmergencyEvent[]   @relation("UserEmergencies")
  resolvedEmergencies EmergencyEvent[]   @relation("ResolvedEmergencies")

  // OPTIMIZED: Removed redundant @@index([zaloId]) - @unique already creates index
  @@index([phone])
  @@index([phoneHash])
  @@index([email])
  @@index([role])
  @@index([status])
  @@index([deletedAt]) // For soft delete queries
  @@map("users")
}

model UserSettings {
  id                 String   @id @default(uuid()) @db.Uuid
  userId             String   @unique @map("user_id") @db.Uuid
  language           String   @default("vi")
  timezone           String   @default("Asia/Ho_Chi_Minh")
  pushNotifications  Boolean  @default(true) @map("push_notifications")
  emailNotifications Boolean  @default(true) @map("email_notifications")
  smsNotifications   Boolean  @default(false) @map("sms_notifications")
  showOnlineStatus   Boolean  @default(true) @map("show_online_status")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

model UserDevice {
  id           String    @id @default(uuid()) @db.Uuid
  userId       String    @map("user_id") @db.Uuid
  deviceId     String    @map("device_id")
  deviceName   String?   @map("device_name")
  deviceType   String?   @map("device_type")
  isTrusted    Boolean   @default(false) @map("is_trusted")
  lastActiveAt DateTime? @map("last_active_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessions   UserSession[]
  pushTokens PushToken[]

  @@index([userId]) // ADDED: FK index
  @@map("user_devices")
}

model UserSession {
  id        String    @id @default(uuid()) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  deviceId  String?   @map("device_id") @db.Uuid
  ipAddress String?   @map("ip_address")
  userAgent String?   @map("user_agent")
  expiresAt DateTime? @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  device UserDevice? @relation(fields: [deviceId], references: [id])

  @@index([userId]) // ADDED: FK index
  @@index([deviceId]) // ADDED: FK index
  @@map("user_sessions")
}

// ============================================
// COMPANION PROFILE
// ============================================

model CompanionProfile {
  id                 String             @id @default(uuid()) @db.Uuid
  userId             String             @unique @map("user_id") @db.Uuid
  bio                String?
  heightCm           Int?               @map("height_cm")
  languages          String[]           @default(["vi"])
  province           String? // Vietnamese province/city code (e.g., "HCM", "HN")
  district           String? // District within province (optional)
  hourlyRate         Int                @map("hourly_rate") // in VND
  halfDayRate        Int?               @map("half_day_rate")
  fullDayRate        Int?               @map("full_day_rate")
  ratingAvg          Decimal            @default(0.0) @map("rating_avg") @db.Decimal(3, 2) // FIXED: Was (2,1), now allows 4.85
  ratingCount        Int                @default(0) @map("rating_count")
  totalBookings      Int                @default(0) @map("total_bookings")
  completedBookings  Int                @default(0) @map("completed_bookings")
  verificationStatus VerificationStatus @default(PENDING) @map("verification_status")
  isFeatured         Boolean            @default(false) @map("is_featured")
  isActive           Boolean            @default(true) @map("is_active")
  isHidden           Boolean            @default(false) @map("is_hidden")
  responseRate       Int                @default(100) @map("response_rate")
  acceptanceRate     Int                @default(100) @map("acceptance_rate")
  deletedAt          DateTime?          @map("deleted_at") // Soft delete support
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")

  user         User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  photos       CompanionPhoto[]
  services     CompanionService[]
  availability CompanionAvailability[]
  bankAccounts BankAccount[]
  earnings     Earning[]
  boosts       ProfileBoost[]
  withdrawals  Withdrawal[]            @relation("CompanionWithdrawals") // ADDED: Missing relation

  @@index([ratingAvg(sort: Desc)])
  @@index([hourlyRate])
  @@index([isActive, isHidden, verificationStatus])
  // ADDED: Composite indexes for search queries
  @@index([isActive, isHidden, verificationStatus, ratingAvg(sort: Desc)])
  @@index([isActive, isHidden, hourlyRate])
  @@index([isActive, isHidden, totalBookings(sort: Desc), ratingAvg(sort: Desc)])
  @@index([province, isActive, isHidden, verificationStatus])
  @@map("companions")
}

model CompanionPhoto {
  id          String   @id @default(uuid()) @db.Uuid
  companionId String   @map("companion_id") @db.Uuid
  url         String
  position    Int      @default(0)
  isVerified  Boolean  @default(false) @map("is_verified")
  isPrimary   Boolean  @default(false) @map("is_primary")
  createdAt   DateTime @default(now()) @map("created_at")

  companion CompanionProfile @relation(fields: [companionId], references: [id], onDelete: Cascade)

  @@index([companionId]) // ADDED: FK index
  @@map("companion_photos")
}

model CompanionService {
  id              String      @id @default(uuid()) @db.Uuid
  companionId     String      @map("companion_id") @db.Uuid
  serviceType     ServiceType @map("service_type")
  description     String?
  priceAdjustment Int         @default(0) @map("price_adjustment") // +/- from base rate
  isEnabled       Boolean     @default(true) @map("is_enabled")
  createdAt       DateTime    @default(now()) @map("created_at")

  companion CompanionProfile @relation(fields: [companionId], references: [id], onDelete: Cascade)

  @@unique([companionId, serviceType])
  @@index([companionId]) // ADDED: FK index (unique doesn't cover all query patterns)
  @@map("companion_services")
}

model CompanionAvailability {
  id           String    @id @default(uuid()) @db.Uuid
  companionId  String    @map("companion_id") @db.Uuid
  dayOfWeek    Int?      @map("day_of_week") // 0-6 (Sunday-Saturday) for recurring
  startTime    String    @map("start_time") // "09:00"
  endTime      String    @map("end_time") // "18:00"
  isRecurring  Boolean   @default(true) @map("is_recurring")
  specificDate DateTime? @map("specific_date") @db.Date
  isAvailable  Boolean   @default(true) @map("is_available")
  createdAt    DateTime  @default(now()) @map("created_at")

  companion CompanionProfile @relation(fields: [companionId], references: [id], onDelete: Cascade)

  @@index([companionId, dayOfWeek])
  @@index([companionId]) // ADDED: FK index
  @@map("companion_availability")
}

// ============================================
// HIRER PROFILE
// ============================================

model HirerProfile {
  id            String    @id @default(uuid()) @db.Uuid
  userId        String    @unique @map("user_id") @db.Uuid
  province      String? // Vietnamese province/city code
  district      String? // District within province (optional)
  totalBookings Int       @default(0) @map("total_bookings")
  totalSpent    Int       @default(0) @map("total_spent") // in VND
  ratingAvg     Decimal   @default(5.0) @map("rating_avg") @db.Decimal(3, 2) // FIXED: Was (2,1)
  ratingCount   Int       @default(0) @map("rating_count")
  deletedAt     DateTime? @map("deleted_at") // Soft delete support
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("hirer_profiles")
}

// ============================================
// VERIFICATION
// ============================================

model Verification {
  id         String             @id @default(uuid()) @db.Uuid
  userId     String             @map("user_id") @db.Uuid
  type       String // 'identity', 'phone', 'email'
  status     VerificationStatus @default(PENDING)
  provider   String? // 'vneid', 'twilio', etc.
  verifiedAt DateTime?          @map("verified_at")
  expiresAt  DateTime?          @map("expires_at")
  metadata   Json               @default("{}")
  createdAt  DateTime           @default(now()) @map("created_at")
  updatedAt  DateTime           @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId]) // ADDED: FK index
  @@index([userId, type]) // ADDED: Composite for user verification lookups
  @@map("verifications")
}

model PhotoVerification {
  id             String   @id @default(uuid()) @db.Uuid
  userId         String   @map("user_id") @db.Uuid
  photoUrl       String   @map("photo_url")
  selfieUrl      String   @map("selfie_url")
  livenessScore  Decimal? @map("liveness_score") @db.Decimal(5, 2)
  faceMatchScore Decimal? @map("face_match_score") @db.Decimal(5, 2)
  status         String   @default("pending")
  failureReason  String?  @map("failure_reason")
  createdAt      DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId]) // ADDED: FK index
  @@map("photo_verifications")
}

// ============================================
// BOOKINGS
// ============================================

model Booking {
  id            String        @id @default(uuid()) @db.Uuid
  bookingNumber String        @unique @map("booking_number") // SOC-2025-XXXX
  hirerId       String        @map("hirer_id") @db.Uuid
  companionId   String        @map("companion_id") @db.Uuid
  status        BookingStatus @default(PENDING)

  // Booking Details
  occasionType    ServiceType? @map("occasion_type") // Deprecated: Use occasionId instead
  occasionId      String?      @map("occasion_id")
  startDatetime   DateTime     @map("start_datetime")
  endDatetime     DateTime     @map("end_datetime")
  durationHours   Decimal      @map("duration_hours") @db.Decimal(4, 2)
  locationAddress String       @map("location_address")
  locationLat     Decimal?     @map("location_lat") @db.Decimal(9, 6) // OPTIMIZED: Was (10,8), now ~10cm precision
  locationLng     Decimal?     @map("location_lng") @db.Decimal(9, 6) // OPTIMIZED: Was (11,8)
  specialRequests String?      @map("special_requests")

  // Pricing
  basePrice   Int @map("base_price") // in VND
  platformFee Int @map("platform_fee") // 18%
  surgeFee    Int @default(0) @map("surge_fee")
  totalPrice  Int @map("total_price")

  // Payment
  paymentStatus PaymentStatus @default(PENDING) @map("payment_status")

  // Cancellation - Use BookingCancellation for detailed info
  cancelledBy  String?   @map("cancelled_by") @db.Uuid
  cancelReason String?   @map("cancel_reason")
  cancelledAt  DateTime? @map("cancelled_at")

  // Timeline
  requestExpiresAt DateTime? @map("request_expires_at") // 24h from creation
  confirmedAt      DateTime? @map("confirmed_at")
  startedAt        DateTime? @map("started_at")
  completedAt      DateTime? @map("completed_at")

  deletedAt DateTime? @map("deleted_at") // Soft delete support
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  hirer           User                 @relation("HirerBookings", fields: [hirerId], references: [id])
  companion       User                 @relation("CompanionBookings", fields: [companionId], references: [id])
  occasion        Occasion?            @relation(fields: [occasionId], references: [id])
  payment         Payment?
  reviews         Review[]
  conversation    Conversation?
  earning         Earning?
  cancellation    BookingCancellation? // ADDED: Structured cancellation data
  paymentRequests PaymentRequest[]

  @@index([hirerId])
  @@index([companionId])
  @@index([status])
  @@index([startDatetime])
  @@index([bookingNumber])
  @@index([occasionId])
  // ADDED: Composite indexes for common query patterns
  @@index([hirerId, status])
  @@index([companionId, status])
  @@index([companionId, startDatetime])
  @@index([status, requestExpiresAt]) // For expired request cleanup
  @@index([status, createdAt(sort: Desc)]) // For admin views
  @@map("bookings")
}

// ADDED: New model for structured cancellation data
model BookingCancellation {
  id               String           @id @default(uuid()) @db.Uuid
  bookingId        String           @unique @map("booking_id") @db.Uuid
  type             CancellationType @default(REGULAR)
  emergencyType    String?          @map("emergency_type") // MEDICAL, FAMILY, SAFETY, etc.
  reason           String
  proofDocumentUrl String?          @map("proof_document_url")
  isVerified       Boolean          @default(false) @map("is_verified")
  cancelledById    String           @map("cancelled_by") @db.Uuid
  verifiedAt       DateTime?        @map("verified_at")
  createdAt        DateTime         @default(now()) @map("created_at")

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([type])
  @@map("booking_cancellations")
}

// ============================================
// PAYMENTS & EARNINGS
// ============================================

model Payment {
  id               String          @id @default(uuid()) @db.Uuid
  bookingId        String          @unique @map("booking_id") @db.Uuid
  userId           String          @map("user_id") @db.Uuid
  amount           Int // in VND
  currency         String          @default("VND")
  provider         PaymentProvider
  providerTxnId    String?         @unique @map("provider_txn_id")
  status           PaymentStatus   @default(PENDING)
  providerResponse Json?           @map("provider_response")
  paidAt           DateTime?       @map("paid_at")
  releasedAt       DateTime?       @map("released_at")
  refundedAt       DateTime?       @map("refunded_at")
  createdAt        DateTime        @default(now()) @map("created_at")

  booking       Booking                @relation(fields: [bookingId], references: [id], onDelete: Restrict) // CHANGED: Restrict delete
  user          User                   @relation(fields: [userId], references: [id])
  statusHistory PaymentStatusHistory[] // ADDED: Audit trail

  @@index([userId]) // ADDED: FK index
  @@index([status]) // ADDED: For status filtering
  @@map("payments")
}

// ADDED: New model for payment status audit trail
model PaymentStatusHistory {
  id         String        @id @default(uuid()) @db.Uuid
  paymentId  String        @map("payment_id") @db.Uuid
  fromStatus PaymentStatus @map("from_status")
  toStatus   PaymentStatus @map("to_status")
  reason     String?
  changedBy  String?       @map("changed_by") @db.Uuid
  createdAt  DateTime      @default(now()) @map("created_at")

  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId, createdAt])
  @@map("payment_status_history")
}

model Earning {
  id          String         @id @default(uuid()) @db.Uuid
  companionId String         @map("companion_id") @db.Uuid
  bookingId   String         @unique @map("booking_id") @db.Uuid
  grossAmount Int            @map("gross_amount") // Total before fees
  platformFee Int            @map("platform_fee") // 18%
  netAmount   Int            @map("net_amount") // What companion receives
  status      EarningsStatus @default(PENDING)
  releasedAt  DateTime?      @map("released_at")
  createdAt   DateTime       @default(now()) @map("created_at")

  companion CompanionProfile @relation(fields: [companionId], references: [id], onDelete: Restrict) // CHANGED: Restrict delete
  booking   Booking          @relation(fields: [bookingId], references: [id], onDelete: Restrict) // CHANGED: Restrict delete

  @@index([companionId])
  @@index([status])
  @@index([companionId, status]) // ADDED: Composite for earnings queries
  @@map("earnings")
}

model BankAccount {
  id            String   @id @default(uuid()) @db.Uuid
  companionId   String   @map("companion_id") @db.Uuid
  bankName      String   @map("bank_name")
  accountNumber String   @map("account_number")
  accountHolder String   @map("account_holder")
  isPrimary     Boolean  @default(false) @map("is_primary")
  isVerified    Boolean  @default(false) @map("is_verified")
  createdAt     DateTime @default(now()) @map("created_at")

  companion   CompanionProfile @relation(fields: [companionId], references: [id], onDelete: Cascade)
  withdrawals Withdrawal[]

  @@index([companionId]) // ADDED: FK index
  @@map("bank_accounts")
}

model Withdrawal {
  id            String           @id @default(uuid()) @db.Uuid
  companionId   String           @map("companion_id") @db.Uuid
  bankAccountId String           @map("bank_account_id") @db.Uuid
  amount        Int // in VND
  status        WithdrawalStatus @default(PENDING)
  requestedAt   DateTime         @default(now()) @map("requested_at")
  completedAt   DateTime?        @map("completed_at")

  companion   CompanionProfile @relation("CompanionWithdrawals", fields: [companionId], references: [id]) // ADDED: Missing relation
  bankAccount BankAccount      @relation(fields: [bankAccountId], references: [id])

  @@index([companionId]) // ADDED: FK index
  @@index([bankAccountId]) // ADDED: FK index
  @@index([status]) // ADDED: For status queries
  @@map("withdrawals")
}

// ============================================
// REVIEWS
// ============================================

model Review {
  id         String    @id @default(uuid()) @db.Uuid
  bookingId  String    @map("booking_id") @db.Uuid
  reviewerId String    @map("reviewer_id") @db.Uuid
  revieweeId String    @map("reviewee_id") @db.Uuid
  rating     Int // 1-5
  comment    String?
  tags       String[]  @default([])
  isVisible  Boolean   @default(true) @map("is_visible")
  isDisputed Boolean   @default(false) @map("is_disputed")
  deletedAt  DateTime? @map("deleted_at") // Soft delete for moderation
  createdAt  DateTime  @default(now()) @map("created_at")

  booking  Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  reviewer User    @relation("ReviewsGiven", fields: [reviewerId], references: [id])
  reviewee User    @relation("ReviewsReceived", fields: [revieweeId], references: [id])

  @@unique([bookingId, reviewerId])
  @@index([revieweeId])
  // ADDED: Composite indexes for review queries
  @@index([revieweeId, isVisible])
  @@index([revieweeId, isVisible, createdAt(sort: Desc)])
  @@map("reviews")
}

// ============================================
// MESSAGING (References to Supabase realtime)
// ============================================

model Conversation {
  id            String    @id @default(uuid()) @db.Uuid
  bookingId     String?   @unique @map("booking_id") @db.Uuid
  hirerId       String    @map("hirer_id") @db.Uuid
  companionId   String    @map("companion_id") @db.Uuid
  lastMessageAt DateTime? @map("last_message_at")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")

  booking   Booking?  @relation(fields: [bookingId], references: [id])
  hirer     User      @relation("HirerConversations", fields: [hirerId], references: [id])
  companion User      @relation("CompanionConversations", fields: [companionId], references: [id])
  messages  Message[]

  @@index([hirerId]) // ADDED: FK index
  @@index([companionId]) // ADDED: FK index
  @@index([hirerId, companionId]) // ADDED: For finding conversations between users
  @@map("conversations")
}

model Message {
  id             String      @id @default(uuid()) @db.Uuid
  conversationId String      @map("conversation_id") @db.Uuid
  senderId       String      @map("sender_id") @db.Uuid
  content        String
  messageType    MessageType @default(TEXT) @map("message_type")
  isRead         Boolean     @default(false) @map("is_read")
  deletedAt      DateTime?   @map("deleted_at") // Soft delete for compliance
  createdAt      DateTime    @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id])

  // OPTIMIZED: Removed redundant @@index([conversationId]) - covered by composite
  @@index([conversationId, createdAt(sort: Desc)])
  @@index([senderId]) // ADDED: FK index
  @@map("messages")
}

// ============================================
// TRUST & SAFETY
// ============================================

model UserBlock {
  id        String   @id @default(uuid()) @db.Uuid
  blockerId String   @map("blocker_id") @db.Uuid
  blockedId String   @map("blocked_id") @db.Uuid
  reason    String?
  createdAt DateTime @default(now()) @map("created_at")

  blocker User @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked User @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockerId]) // ADDED: FK index
  @@index([blockedId]) // ADDED: FK index
  @@map("user_blocks")
}

model Report {
  id           String       @id @default(uuid()) @db.Uuid
  reporterId   String       @map("reporter_id") @db.Uuid
  reportedId   String       @map("reported_id") @db.Uuid
  bookingId    String?      @map("booking_id") @db.Uuid
  type         ReportType
  description  String
  evidenceUrls String[]     @default([]) @map("evidence_urls")
  status       ReportStatus @default(PENDING)
  resolution   String?
  createdAt    DateTime     @default(now()) @map("created_at")
  resolvedAt   DateTime?    @map("resolved_at")

  reporter User @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)
  reported User @relation("Reported", fields: [reportedId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([status, createdAt])
  @@index([reporterId]) // ADDED: FK index
  @@index([reportedId]) // ADDED: FK index
  @@map("reports")
}

model UserStrike {
  id        String     @id @default(uuid()) @db.Uuid
  userId    String     @map("user_id") @db.Uuid
  type      StrikeType
  reason    String
  bookingId String?    @map("booking_id") @db.Uuid
  expiresAt DateTime?  @map("expires_at")
  isActive  Boolean    @default(true) @map("is_active")
  createdAt DateTime   @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isActive])
  @@map("user_strikes")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        String           @id @default(uuid()) @db.Uuid
  userId    String           @map("user_id") @db.Uuid
  type      NotificationType
  title     String
  body      String
  data      Json             @default("{}")
  actionUrl String?          @map("action_url")
  isRead    Boolean          @default(false) @map("is_read")
  readAt    DateTime?        @map("read_at")
  createdAt DateTime         @default(now()) @map("created_at")

  user User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs NotificationLog[]

  // ADDED: Critical indexes for notification queries
  @@index([userId])
  @@index([userId, isRead])
  @@index([userId, isRead, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([type, createdAt])
  @@map("notifications")
}

model PushToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  deviceId  String?  @map("device_id") @db.Uuid
  token     String
  platform  String
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  device UserDevice? @relation(fields: [deviceId], references: [id])

  @@index([userId]) // ADDED: FK index
  @@index([deviceId]) // ADDED: FK index
  @@index([userId, isActive]) // ADDED: For active token queries
  @@map("push_tokens")
}

model NotificationLog {
  id             String   @id @default(uuid()) @db.Uuid
  notificationId String   @map("notification_id") @db.Uuid
  channel        String
  status         String
  providerId     String?  @map("provider_id")
  errorMessage   String?  @map("error_message")
  sentAt         DateTime @default(now()) @map("sent_at")

  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@index([notificationId]) // ADDED: FK index
  @@map("notification_logs")
}

// ============================================
// MODERATION
// ============================================

model ModerationQueue {
  id          String                @id @default(uuid()) @db.Uuid
  contentType ModerationContentType @map("content_type")
  contentId   String                @map("content_id") @db.Uuid
  userId      String                @map("user_id") @db.Uuid
  priority    Int                   @default(0)
  flags       Json                  @default("[]")
  status      ModerationStatus      @default(PENDING)
  assignedTo  String?               @map("assigned_to") @db.Uuid
  createdAt   DateTime              @default(now()) @map("created_at")
  updatedAt   DateTime              @updatedAt @map("updated_at")

  user    User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  actions ModerationAction[]

  @@index([userId]) // ADDED: FK index
  @@index([assignedTo]) // ADDED: FK index
  @@index([status, priority(sort: Desc), createdAt]) // ADDED: For queue processing
  @@map("moderation_queue")
}

model ModerationAction {
  id          String               @id @default(uuid()) @db.Uuid
  queueId     String               @map("queue_id") @db.Uuid
  moderatorId String               @map("moderator_id") @db.Uuid
  action      ModerationActionType
  reason      String?
  notes       String?
  createdAt   DateTime             @default(now()) @map("created_at")

  queue     ModerationQueue @relation(fields: [queueId], references: [id], onDelete: Cascade)
  moderator User            @relation("Moderator", fields: [moderatorId], references: [id])

  @@index([queueId]) // ADDED: FK index
  @@index([moderatorId]) // ADDED: FK index
  @@map("moderation_actions")
}

model UserSuspension {
  id             String    @id @default(uuid()) @db.Uuid
  userId         String    @map("user_id") @db.Uuid
  reason         String
  suspendedById  String    @map("suspended_by") @db.Uuid
  suspendedAt    DateTime  @default(now()) @map("suspended_at")
  suspendedUntil DateTime? @map("suspended_until")
  isPermanent    Boolean   @default(false) @map("is_permanent")
  liftedAt       DateTime? @map("lifted_at")
  liftedById     String?   @map("lifted_by") @db.Uuid

  user        User     @relation("SuspendedUser", fields: [userId], references: [id], onDelete: Cascade)
  suspendedBy User     @relation("SuspendedBy", fields: [suspendedById], references: [id])
  liftedBy    User?    @relation("LiftedBy", fields: [liftedById], references: [id])
  appeals     Appeal[]

  @@index([userId]) // ADDED: FK index
  @@index([suspendedById]) // ADDED: FK index
  @@map("user_suspensions")
}

model Appeal {
  id           String       @id @default(uuid()) @db.Uuid
  userId       String       @map("user_id") @db.Uuid
  suspensionId String?      @map("suspension_id") @db.Uuid
  appealText   String       @map("appeal_text")
  status       AppealStatus @default(PENDING)
  reviewedById String?      @map("reviewed_by") @db.Uuid
  reviewNotes  String?      @map("review_notes")
  createdAt    DateTime     @default(now()) @map("created_at")
  reviewedAt   DateTime?    @map("reviewed_at")

  user       User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  suspension UserSuspension? @relation(fields: [suspensionId], references: [id])
  reviewedBy User?           @relation("AppealReviewer", fields: [reviewedById], references: [id])

  @@index([userId]) // ADDED: FK index
  @@index([suspensionId]) // ADDED: FK index
  @@index([status]) // ADDED: For status filtering
  @@map("appeals")
}

// ============================================
// FILE MANAGEMENT
// ============================================

model File {
  id               String   @id @default(uuid()) @db.Uuid
  userId           String   @map("user_id") @db.Uuid
  filename         String
  originalFilename String?  @map("original_filename")
  mimeType         String   @map("mime_type")
  sizeBytes        Int      @map("size_bytes")
  storageKey       String   @map("storage_key")
  cdnUrl           String?  @map("cdn_url")
  variants         Json     @default("{}")
  metadata         Json     @default("{}")
  isPublic         Boolean  @default(false) @map("is_public")
  createdAt        DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId]) // ADDED: FK index
  @@map("files")
}

// ============================================
// SECURITY
// ============================================

model IpBlocklist {
  id           String    @id @default(uuid()) @db.Uuid
  ipAddress    String    @map("ip_address")
  reason       String?
  blockedBy    String?   @map("blocked_by") @db.Uuid
  blockedUntil DateTime? @map("blocked_until")
  createdAt    DateTime  @default(now()) @map("created_at")

  @@index([ipAddress]) // ADDED: For IP lookups
  @@map("ip_blocklist")
}

model SecurityEvent {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  eventType String   @map("event_type")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  details   Json     @default("{}")
  severity  String   @default("info")
  createdAt DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  // ADDED: Critical indexes for security event queries
  @@index([userId])
  @@index([userId, createdAt(sort: Desc)])
  @@index([eventType, createdAt])
  @@index([severity, createdAt])
  @@index([ipAddress])
  @@map("security_events")
}

// ============================================
// ADMIN & SUPPORT
// ============================================

model FeatureFlag {
  id                String   @id @default(uuid()) @db.Uuid
  key               String   @unique
  name              String
  description       String?
  isEnabled         Boolean  @default(false) @map("is_enabled")
  rolloutPercentage Int      @default(0) @map("rollout_percentage")
  userWhitelist     Json     @default("[]") @map("user_whitelist")
  conditions        Json     @default("{}")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("feature_flags")
}

model AdminAuditLog {
  id           String   @id @default(uuid()) @db.Uuid
  adminId      String   @map("admin_id") @db.Uuid
  action       String
  resourceType String   @map("resource_type")
  resourceId   String?  @map("resource_id") @db.Uuid
  oldValue     Json?    @map("old_value")
  newValue     Json?    @map("new_value")
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  createdAt    DateTime @default(now()) @map("created_at")

  admin User @relation(fields: [adminId], references: [id])

  @@index([adminId]) // ADDED: FK index
  @@index([resourceType, resourceId]) // ADDED: For resource lookup
  @@index([createdAt(sort: Desc)]) // ADDED: For recent logs
  @@map("admin_audit_logs")
}

model SupportTicket {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  subject     String
  description String
  category    String?
  priority    String   @default("normal")
  status      String   @default("open")
  assignedTo  String?  @map("assigned_to") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user     User                   @relation("TicketUser", fields: [userId], references: [id], onDelete: Cascade)
  assignee User?                  @relation("TicketAssignee", fields: [assignedTo], references: [id])
  messages SupportTicketMessage[]

  @@index([userId]) // ADDED: FK index
  @@index([assignedTo]) // ADDED: FK index
  @@index([status, createdAt(sort: Desc)]) // ADDED: For ticket queue
  @@map("support_tickets")
}

model SupportTicketMessage {
  id          String   @id @default(uuid()) @db.Uuid
  ticketId    String   @map("ticket_id") @db.Uuid
  senderId    String   @map("sender_id") @db.Uuid
  message     String
  attachments Json     @default("[]")
  isInternal  Boolean  @default(false) @map("is_internal")
  createdAt   DateTime @default(now()) @map("created_at")

  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  sender User          @relation(fields: [senderId], references: [id])

  @@index([ticketId]) // ADDED: FK index
  @@index([senderId]) // ADDED: FK index
  @@map("support_ticket_messages")
}

model SystemConfig {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @unique
  value       Json
  description String?
  updatedBy   String?  @map("updated_by") @db.Uuid
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("system_config")
}

// ============================================
// SAFETY & EMERGENCY
// ============================================

enum EmergencyEventStatus {
  ACTIVE
  CANCELLED
  RESOLVED
  ESCALATED
}

model EmergencyContact {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  name         String
  phone        String
  relationship String?
  isPrimary    Boolean  @default(false) @map("is_primary")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("emergency_contacts")
}

model EmergencyEvent {
  id           String               @id @default(uuid()) @db.Uuid
  userId       String               @map("user_id") @db.Uuid
  bookingId    String?              @map("booking_id") @db.Uuid
  alertType    String               @map("alert_type") // EMERGENCY, UNCOMFORTABLE, HARASSMENT, SAFETY_CONCERN
  status       EmergencyEventStatus @default(ACTIVE)
  locationLat  Decimal?             @map("location_lat") @db.Decimal(9, 6) // OPTIMIZED: Was (10,8)
  locationLng  Decimal?             @map("location_lng") @db.Decimal(9, 6) // OPTIMIZED: Was (11,8)
  message      String?
  triggeredAt  DateTime             @default(now()) @map("triggered_at")
  cancelledAt  DateTime?            @map("cancelled_at")
  escalatedAt  DateTime?            @map("escalated_at")
  resolvedAt   DateTime?            @map("resolved_at")
  resolvedById String?              @map("resolved_by") @db.Uuid
  notes        String?

  user       User  @relation("UserEmergencies", fields: [userId], references: [id], onDelete: Cascade)
  resolvedBy User? @relation("ResolvedEmergencies", fields: [resolvedById], references: [id])

  @@index([userId])
  @@index([status])
  @@index([triggeredAt])
  @@map("emergency_events")
}

// ============================================
// FAVORITES
// ============================================

model FavoriteCompanion {
  id          String   @id @default(uuid()) @db.Uuid
  hirerId     String   @map("hirer_id") @db.Uuid
  companionId String   @map("companion_id") @db.Uuid
  notes       String? // Private notes for the hirer
  createdAt   DateTime @default(now()) @map("created_at")

  hirer     User @relation("HirerFavorites", fields: [hirerId], references: [id], onDelete: Cascade)
  companion User @relation("FavoritedBy", fields: [companionId], references: [id], onDelete: Cascade)

  @@unique([hirerId, companionId])
  @@index([hirerId])
  @@index([companionId])
  @@map("favorite_companions")
}

// ============================================
// PROFILE BOOSTS
// ============================================

enum BoostStatus {
  PENDING // Payment pending
  ACTIVE // Currently boosted
  EXPIRED // Boost period ended
  CANCELLED // Manually cancelled
}

enum BoostTier {
  STANDARD // 24 hours, moderate visibility
  PREMIUM // 48 hours, high visibility
  SUPER // 72 hours, maximum visibility
}

model ProfileBoost {
  id          String      @id @default(uuid()) @db.Uuid
  companionId String      @map("companion_id") @db.Uuid
  tier        BoostTier   @default(STANDARD)
  status      BoostStatus @default(PENDING)
  multiplier  Decimal     @default(1.5) @db.Decimal(3, 2) // Ranking multiplier
  price       Int // Amount paid in VND
  startedAt   DateTime?   @map("started_at")
  expiresAt   DateTime?   @map("expires_at")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  companion CompanionProfile @relation(fields: [companionId], references: [id], onDelete: Cascade)

  @@index([companionId])
  @@index([status])
  @@index([expiresAt])
  @@index([companionId, status, expiresAt]) // ADDED: For active boost lookups
  @@index([status, expiresAt]) // ADDED: For expiration batch jobs
  @@map("profile_boosts")
}

// ============================================
// REFERRALS
// ============================================

model Referral {
  id            String   @id @default(uuid()) @db.Uuid
  userId        String   @unique @map("user_id") @db.Uuid
  code          String   @unique
  totalUses     Int      @default(0) @map("total_uses")
  totalEarnings Int      @default(0) @map("total_earnings")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  user          User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  referredUsers User[] @relation("ReferredUsers")

  @@map("referrals")
}

// ============================================
// OCCASIONS & HOLIDAYS
// ============================================

model Occasion {
  id            String  @id @default(cuid())
  code          String  @unique
  emoji         String
  nameEn        String  @map("name_en")
  nameVi        String  @map("name_vi")
  descriptionEn String? @map("description_en")
  descriptionVi String? @map("description_vi")
  displayOrder  Int     @default(0) @map("display_order")
  isActive      Boolean @default(true) @map("is_active")

  // Context filters - empty array means "show anytime"
  timeSlots String[] @default([]) @map("time_slots") // ["morning", "afternoon", "evening", "night"]
  dayTypes  String[] @default([]) @map("day_types") // ["weekday", "weekend"]
  holidays  String[] @default([]) @map("holidays") // ["tet", "christmas", "valentine"]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  bookings     Booking[]
  interactions OccasionInteraction[]

  @@index([isActive, displayOrder])
  @@map("occasions")
}

model Holiday {
  id          String   @id @default(cuid())
  code        String   @unique
  nameEn      String   @map("name_en")
  nameVi      String   @map("name_vi")
  startDate   DateTime @map("start_date")
  endDate     DateTime @map("end_date")
  isRecurring Boolean  @default(true) @map("is_recurring")
  isActive    Boolean  @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([startDate, endDate, isActive])
  @@map("holidays")
}

// Occasion interaction events for tracking usage metrics
enum OccasionEventType {
  VIEW           // Occasion appeared in list
  SELECT         // User selected this occasion
  BOOKING_CREATED // Booking was created with this occasion
}

model OccasionInteraction {
  id         String             @id @default(uuid()) @db.Uuid
  userId     String?            @map("user_id") @db.Uuid // Nullable for anonymous tracking
  occasionId String             @map("occasion_id")
  eventType  OccasionEventType  @map("event_type")
  sessionId  String?            @map("session_id")
  metadata   Json               @default("{}")
  createdAt  DateTime           @default(now()) @map("created_at")

  occasion Occasion @relation(fields: [occasionId], references: [id], onDelete: Cascade)

  @@index([occasionId, createdAt(sort: Desc)])
  @@index([eventType, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@map("occasion_interactions")
}

// ============================================
// RECOMMENDATIONS
// ============================================

enum InteractionEventType {
  VIEW // Profile card appeared in viewport
  PROFILE_OPEN // Tapped to view full profile
  BOOKMARK // Added to favorites
  UNBOOKMARK // Removed from favorites
  MESSAGE_SENT // Sent first message
  BOOKING_STARTED // Entered booking flow
  BOOKING_COMPLETED // Completed booking
  BOOKING_CANCELLED // Cancelled booking
}

model UserInteraction {
  id          String               @id @default(uuid()) @db.Uuid
  userId      String               @map("user_id") @db.Uuid
  companionId String               @map("companion_id") @db.Uuid
  eventType   InteractionEventType @map("event_type")
  eventValue  Decimal              @default(0) @map("event_value") @db.Decimal(4, 2) // Weighted score
  dwellTimeMs Int?                 @map("dwell_time_ms") // Time spent viewing (for profile_open)
  sessionId   String?              @map("session_id")
  metadata    Json                 @default("{}")
  createdAt   DateTime             @default(now()) @map("created_at")

  @@index([userId, createdAt(sort: Desc)])
  @@index([companionId, createdAt(sort: Desc)])
  @@index([userId, companionId, eventType])
  @@map("user_interactions")
}

model RecommendationCache {
  id           String   @id @default(uuid()) @db.Uuid
  userId       String   @unique @map("user_id") @db.Uuid
  companions   Json // Array of { companionId, score, reason }
  algorithmVer String   @default("v1") @map("algorithm_ver")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([expiresAt])
  @@map("recommendation_cache")
}

// ============================================
// PAYMENT REQUESTS (SePay Wallet Integration)
// ============================================

enum PaymentRequestType {
  TOPUP
  BOOKING
}

enum PaymentRequestStatus {
  PENDING
  COMPLETED
  EXPIRED
  FAILED
}

// Payment Request for SePay QR payments (wallet topups and direct booking payments)
model PaymentRequest {
  id     String               @id @default(uuid()) @db.Uuid
  userId String               @map("user_id") @db.Uuid
  code   String               @unique // HM-XXXXXXX format
  type   PaymentRequestType
  amount Int // Amount in VND
  status PaymentRequestStatus @default(PENDING)

  // For BOOKING type only
  bookingId String? @map("booking_id") @db.Uuid

  // SePay webhook data (populated on completion)
  sepayId       Int?    @map("sepay_id")
  gateway       String?
  referenceCode String? @map("reference_code")

  // Webhook idempotency tracking
  webhookLogId String? @map("webhook_log_id") @db.Uuid

  expiresAt   DateTime  @map("expires_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  booking    Booking?    @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  webhookLog WebhookLog? @relation(fields: [webhookLogId], references: [id])

  @@index([userId])
  @@index([code])
  @@index([status, expiresAt])
  @@map("payment_requests")
}

// ============================================
// WEBHOOK IDEMPOTENCY (Prevents duplicate webhook processing)
// ============================================

model WebhookLog {
  id             String   @id @default(uuid()) @db.Uuid
  idempotencyKey String   @unique @map("idempotency_key")
  source         String // "sepay", "bank_transfer", "stripe", etc.
  endpoint       String // Webhook endpoint path
  status         String   @default("processing") // "processing", "completed", "failed"
  response       Json? // Response data for debugging
  processedAt    DateTime @default(now()) @map("processed_at")
  createdAt      DateTime @default(now()) @map("created_at")

  paymentRequests PaymentRequest[]

  @@index([source, createdAt(sort: Desc)])
  @@map("webhook_logs")
}

// ============================================
// IDEMPOTENCY (API Request Deduplication)
// ============================================

model IdempotencyKey {
  id           String   @id @default(uuid()) @db.Uuid
  key          String   @unique
  userId       String   @map("user_id") @db.Uuid
  endpoint     String // e.g., "POST /wallet/topup"
  requestHash  String?  @map("request_hash") // Hash of request body
  responseCode Int      @map("response_code")
  responseBody Json     @map("response_body")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([key])
  @@index([userId])
  @@index([expiresAt])
  @@map("idempotency_keys")
}
